#!/bin/bash

# Common
source "${0%/*}/config/common"

# Move to the home directory
cd $pathRoot

# Make sure everything is stopped..
$pathRoot/stop


# Ensure the needed stuff is here
touch $pathRoot/config/machine
touch $pathRoot/config/schedule
touch $pathRoot/config/init-schedule
touch $pathRoot/config/init-meta
touch $pathRoot/config/init-vlc
touch $pathRoot/config/init-media

#if [ "$1" == "debug" ]; then
 logVLC=$pathRoot/log/vlc.log
 optionsVLC="--http-password capture -vvvvv"
 log "Starting in debug mode (logging to $logVLC)"
#else
# logVLC=/dev/null
# optionsVLC="--http-password capture"
#fi


# Start the HTTP interface
cvlc --intf=http --http-port=8888  --http-src="$pathRoot" $optionsVLC  --vlm-conf="$pathRoot/config/init-vlc"  >> "$logVLC" 2>&1  &


# Sleep for a bit, then set the video and audio options
sleep 3
if [ ! "$(pidof vlc)" ]
then
  echo "Whoops!  VLC didn't start!"
  exit 1
fi

# Set up audio and video
 source $pathRoot/config/init-audio &> /dev/null
 source $pathRoot/config/init-video &> /dev/null


  ip=$(hostname -I)
  hostname=$(hostname)
  mac=$(ifconfig eth0 | grep -o -E '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}')
 
  echo "----------------------------"
  echo "Machine Settings"
  echo "----------------------------"
  echo "        IP : $ip"
  echo "       MAC : $mac"
  echo "  HOSTNAME : $hostname"
  echo "    MANAGE : http://$ip:8888"
  echo "----------------------------"
  
  $pathRoot/notify "$roomID : $ip" "Capture started : $ip / $mac / $hostname"


