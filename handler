#!/bin/bash

# Common
source "${0%/*}/config/common"
source "${0%/*}/config/machine"

file=$1
trigger=$2

echo $(date)" : $file - $trigger" >> $logFile

# If we can actually find the file..
if [ ! -e "$file" ] 
then
  #echo "$file not found!" >> $logFile
  exit 1
fi

# .. and the file is an original recording
base=$(basename "$file")
ext="${base##*.}"
if [ ! $ext == "mp4" ] 
then
  #echo "$file not a recording" >> $logFile
 exit 1
fi

# ... and we have somewhere to upload it..
if [ -z "$urlUpload" ]
then
  #echo "No upload required" >> $logFile
  exit 1
fi

# .. and the file isn't currently open (incrontab can be weird)
statA=$(ls -l "$file")
sleep 2
statB=$(ls -l "$file")
if [ ! "$statA" == "$statB" ]
then
   echo "Ignoring (file is open) $file" >> $logFile
   exit 1
fi

logFile="$file.log"
{

         echo "Handler start"  >> "$logFile"

   	     # Convert the file  
         source="$file"
         dest="$file.converted"

         echo "Pre Conversion : $file " >> "$logFile"
         set -x
         /usr/bin/HandBrakeCLI -i "$source" -o "$dest" --encoder x264 --optimize --start-at frame:5 2&> "$source.convert.log"
         set +x

         if [ -e "$dest" ] 
         then
           file="$dest"
         fi
         echo "Post Conversion : $file " >> "$logFile"

         # Get the stats of the file
         /usr/bin/avprobe "$file" &> "$file.info"

         # If the filename is a date, use it as the start time
         basename=$(basename "$file")
         IFS='.' read -a names <<< "$basename"
         epoch=${names[0]}
         
         # date -d @$epoch > /dev/null 2>&1
         #if [ ! $? -eq 1 ]
         #then
         #   asOf="$epoch"
         #   echo "Using filename ($baseName) as creation date" >> "$logFile"
         #else
         #   asOf=$(stat -c "%s" $file)
         #   echo "Using file modified date ($asOf)" 
         #fi
         

         asOf="$epoch"

         #Use the local init-schedule file to look up metadata
         echo "Metadata date is : $asOf" >> "$logFile"
         info=$($pathRoot/parse meta-epoch "$asOf")

         # Couldn't find anything?  That's OK.. use the default stuff
         if [ "$info" == "" ]
         then
             echo "Couldn't find metadata : $roomID / $asOf" >> "$logFile"
             title="$roomID Recording"
             description="Ad-hoc recording"
             owner="capture-$roomID"
         else 
             echo "Matched : $info" >> "$logFile"
             IFS='|' read title description owner <<< "$info"
         fi

         echo "$title|$description|$owner" > $file.meta 
                    
         # Post to the media server
         set -x
         /usr/bin/curl -F "title=$title" -F "description=$description" -F "uploadedUser=$owner" -F "batchMode=Y" -F "public=1" -F "convert=no" -F "keywords=$roomID $baseName lecture" -F "file=@$file" "$urlUpload"
         set +x

         # Archive the original file
         if [[ "$info" == *Success* ]]
         then
              echo "$file was sucessfully uploaded" >> "$logFile"
              mv "$file" "$file.uploaded"
         else
              $pathRoot/notify "Upload Error" "$file\n$info"
         fi


}


