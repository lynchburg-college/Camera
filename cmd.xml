<?vlc
require "httprequests"

function os.capture(cmd, raw)
  local f = assert(io.popen(cmd, 'r'))
  local s = assert(f:read('*a'))
  f:close()
  if raw then return s end
  return s
end

function pairsByKeys (t, f)
      local a = {}
      for n in pairs(t) do table.insert(a, n) end
      table.sort(a, f)
      local i = 0      -- iterator variable
      local iter = function ()   -- iterator function
        i = i + 1
        if a[i] == nil then return nil
        else return a[i], t[a[i]]
        end
      end
      return iter
 end


function getProperties ( collection )

   local o={}
   
   for k,v in pairsByKeys(collection) do

    if(type(v.children) == "table" ) then
     o[v.name]=getProperties( v.children )
    else
     o[v.name]=v.value
    end

   end

   return o
end

json = {}

command=_GET["command"]
if(command == nil) then
  command="show"
end

if( command == "show videos") then
   result = vlc.net.opendir( 'video' )

elseif( command == "show camera") then
   result = os.capture( 'v4l2-ctl -L' )

else

   response = vlc.vlm():execute_command( command )
   if( type(response.children) == "table" ) then
      result = getProperties( response.children )
   else
      result = response.value
   end
end


json["command"] = command
json["timestamp"]=os.date("%Y-%m-%d %H:%M:%S (%a)")
json["result"]=result

httprequests.printTableAsJson(json)

?>
