#!/bin/bash

source "${0%/*}/config/common"

#  if [ $(whoami) != "root" ]
#  then
#    echo "Setup must be run as root (ie. sudo ./setup)"
#    exit
#  fi


  echo "----------------------------"
  echo "Current Machine Settings"
  echo "----------------------------"
  echo "      ROOM : $room"
  echo "  ROOMNAME : $roomName"
  echo "----------------------------"
  echo ""
 
  read -p "New Room Code ($room) : " value
  [ "$value" == "" ] || room=${value//[[:space:]]/}

  read -p "New Room Description ($roomName) : " value
  [ "$value" == "" ] || roomName=$value

  echo -e "#--- Configuration updated $(date)\n\nroom=$room\nroomName=\"$roomName\"" > $pathRoot/config/machine
  chown capture $pathRoot/config/machine
    
  mkdir $pathRoot/video
  chown capture $pathRoot/video

  mkdir $pathRoot/log
  chown capture $pathRoot/log

  mkdir $pathRoot/config
  chown capture $pathRoot/log

  echo "----------------------------"
  echo "New Machine Settings (written to $pathRoot/config/machine)"
  echo "----------------------------"
  echo "      ROOM : $room"
  echo "  ROOMNAME : $roomName"
  echo ""

  command="/home/capture/Camera/upload"
  job="\n# Capture Upload\n05,35 * * * * $command\n"
  cat <(fgrep -i -v "$command" <(crontab -l)) <(echo -e "$job") | crontab -

  command="/home/capture/Camera/schedule"
  job="\n# Get the schedule\n0 1 * * 0 $command\n"
  cat <(fgrep -i -v "$command" <(crontab -l)) <(echo -e "$job") | crontab -

  echo "Scheduled upload job created"


  echo ""
  echo "... setup complete."
  
  ./start

  





