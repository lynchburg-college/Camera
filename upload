#!/bin/bash

# Common
source "${0%/*}/config/common"

touch $logFile

{

# Only check if we aren't busy recording (or uploading)
isBusy=$(lsof $pathVideo/*)
if [ -z "$isBusy" ]
then

  #  Find the first file that needs to be uploaded
  file=$(ls -t $pathVideo/*.mp4 2>/dev/null | head -1)
  if [ ! -z "$file" ] && [ -s $file ]  
  then

   log "Found $file"

   # If the filename is a date, use it as the start time
   asOf=$(basename "$file")

   asOf="${asOf%.*}"
   date -d "$asOf" > /dev/null 2>&1
   if [ $? -eq 1 ]
   then
     #.. otherwise, use the last modified time of the file
     asOf=$(date "+$formatISO" -d "$(stat -c "%y" $file)")
   fi

   # Ask the server for info about the class meeting at that time
   url="$urlInfo?room=$room&asOf=$asOf&mode=meeting"
   log "Calling $url"
   info=$(curl -sL "$url")
   log "Got $info"


   # Rename to show that we are uploading..
   mv $file $file.uploading

   # Post to the media server
   cmd="curl -F \"batchMode=Y\" $info -F \"file=@$file.uploading\" $urlUpload"
   log "$cmd"
   info=$(eval "$cmd")

   # If successful (response from server) then rename it.
   if [[ "$info" == *Success* ]]
   then
	# rm "$file.uploading"
        mv "$file.uploading" "$file.uploaded"
        log "$file was sucessfully uploaded"
   else
        log "$info "
        $pathRoot/notify "Upload Error" "$file\n$info"
        mv "$file.uploading" "$file.error"
   fi


  fi

fi
} | tee -a $logFile

