#!/bin/bash

# Common
source "${0%/*}/config/common"
source "${0%/*}/config/machine"

# Apply camera and audio settings 
include "config/init-video"
include "config/init-audio"

if [ -z "$urlUpload" ]
then
  exit 1
fi

# Update the timestamp on the log file
touch $logFile

# If an upload is already in progress, skip this pass.
pidCurl=$(ps -A | grep "curl")
if [ ! "$pidCurl" == "" ]
then
 log "Upload already in progress."
 exit 1
fi


#  Find all the files that should can be considered for upload
{
for file in $(ls $pathVideo/*.mp4)
   do

      if [ ! -z "$file" ] && [ -s $file ]  
      then
        isBusy=$(lsof $file)
        if [ ! -z "$isBusy" ]
        then
          log "Ignoring (file is open) $file"

        else
           log "Found $file"

        fi

     fi

done

} | tee -a $logFile


# Remove uploaded stuff older than 1 week
find "$pathVideo/*.uploaded" -mtime +5 -exec rm {} \;

# Alert if space is low
spaceUsed=$(df $pathVideo | tail -1 | awk '{print $5}' | sed 's/%//g')
[[ $spaceUsed -gt 70 ]] && $pathRoot/notify  "Storage Space Used : $spaceUsed%"



